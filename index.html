<script>
let cart = [];
let total = 0;

/* Render Items */
function renderItems() {
    const container = document.getElementById("itemsContainer");
    container.innerHTML = "";

    const search = document.getElementById("searchBar").value.toLowerCase();
    const category = document.getElementById("categorySelect").value;

    items
        .filter(item =>
            (category === "all" || item.category.toLowerCase() === category.toLowerCase()) &&
            item.name.toLowerCase().includes(search)
        )
        .forEach(item => {
            container.innerHTML += `
                <div class="item">
                    <img src="${item.img}">
                    <h3>${item.name}</h3>
                    <p>Price: NT$${item.price}</p>
                    Quantity: 
                    <input type="number" id="qty-${item.name}" value="1" min="1" style="width:50px;">
                    <br><br>
                    <button onclick="addToCart('${item.name}', ${item.price})">Add to Cart</button>
                </div>
            `;
        });
}

/* Add to Cart */
function addToCart(name, price) {
    const qty = parseInt(document.getElementById("qty-" + name).value);

    // Check if item is already in cart
    const existingItem = cart.find(i => i.name === name);
    if (existingItem) {
        existingItem.qty += qty; // increase quantity
    } else {
        cart.push({ name, price, qty }); // add new item
    }

    total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

    document.getElementById("dingSound").play();
    renderCart();
}

/* Render Cart */
function renderCart() {
    const list = document.getElementById("cartList");
    list.innerHTML = "";

    cart.forEach((item, index) => {
        list.innerHTML += `
            <li>${item.name} x${item.qty} – NT$${item.price * item.qty} 
                <button onclick="removeItem(${index})">❌</button>
            </li>`;
    });

    document.getElementById("total").innerText = total;

    document.getElementById("paymentRule").innerText =
        total >= 500 ? "Cash Before Delivery" : "Cash Only";
}

/* Remove Item */
function removeItem(index) {
    cart.splice(index, 1);
    total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
    renderCart();
}

/* Checkout via mailto */
function checkout() {
    if (cart.length === 0) {
        alert("Cart is empty!");
        return;
    }

    const order = cart.map(i => `${i.name} x${i.qty} - NT$${i.price * i.qty}`).join("%0A");
    const payment = total >= 500 ? "Cash Before Delivery" : "Cash Only";

    window.location.href =
        `mailto:leofoooo132@gmail.com?subject=New Order&body=Order:%0A${order}%0A%0ATotal: NT$${total}%0APayment: ${payment}`;
}
</script>
